import sys
sys.path.append("/home/kali/Agent")
print(sys.path)
import time
from langchain_core.tools import tool, BaseTool

from tool.LinuxConnect import LinuxConnect
from contant.LinuxContant import LHOST, username, password

'''
检测到靶机存在MS17-010（Eternal blue永恒之蓝）漏洞后，使用msf(Metasploit Framework)对靶机进行攻击，首先打开msf控制台
'''


class msfconsole(BaseTool):
    name = "msfconsole"
    description = "开启msfconsole"

    def _run(self):
        command = 'msfrpcd -U msf -P msf -S -f'
        connect = LinuxConnect(LHOST, username, password)
        output = ""  # 用于存储输出的字符串变量
        try:
            # 执行命令
            stdin, stdout, stderr = connect.ssh.exec_command(command, get_pty=True)
            # 输出命令执行结果
            start_time = time.time()
            while True:
                if stdout.channel.recv_ready():
                    output += stdout.channel.recv(1024).decode()
                if stdout.channel.exit_status_ready():
                    break
                if time.time() - start_time > 5:  # 设置超时时间为30秒
                    break
        except Exception as e:
            output += f"Error: {e}"
        return f"开启msf{output}"


if __name__ == '__main__':
    console = msfconsole()
    run = console._run()
    print(run)
