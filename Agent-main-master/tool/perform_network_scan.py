import sys
sys.path.append("/home/kali/Agent/Agent-main-master/")
sys.path.append("/home/kali/Agent/Agent-main-master/contant/")

import logging
from pydantic import Field
from pydantic import BaseModel
from typing import Annotated, Type
from langchain_core.tools import BaseTool
from contant.LinuxContant import LHOST, username, password
from tool.LinuxConnect import LinuxConnect

class NetworkScanInput(BaseModel):
    network_segment: str = Field(..., description="Network segment address")

class perform_network_scan(BaseTool):
    """Perform network scan using Nmap."""
    name = "perform_network_scan"
    description = "一个接受字符串网段地址作为输入的网段扫描工具,识别靶机的IP地址"
    args_schema: Type[BaseModel] = NetworkScanInput

    def _run(self, network_segment: str):
        ip_target = ''
        connect = LinuxConnect(LHOST, username, password)
        # connect.ssh.exec_command('sudo -i')
        # 构建 nmap 命令
        command_network = (f'sudo nmap -sn {network_segment}')

        try:
            logging.info(f"写入命令行：{command_network}")
            stdin, stdout, stderr = connect.ssh.exec_command('echo %s | sudo -S %s' % (password, command_network))
            logging.info(f"成功获得网段扫描信息:{stdout}")
        except:
            raise Exception("系统异常")
        # 处理网段扫描结果
        # 按换行符拆分字符串
        lines = stdout.read().decode().split('\n')
        # 遍历每行，找到包含 "Nmap scan report" 的行并截取 IP 地址
        ip_addresses = []
        # ip_cnt = 0
        for line in lines:
            if "Nmap scan report" in line:
                ip_address = line.split('for ')[1].split()[0]
                ip_addresses.append(ip_address)
                # ip_cnt += 1
        # 虚拟机服务器ip
        ip_server1 = "192.168.92.254"
        ip_server2 = "192.168.92.2"
        ip_server3 = "192.168.92.131"

        # 攻击机ip
        ip_self = LHOST
        # 输出截取到的 IP 地址
        skip_ips = {ip_server1, ip_server2, ip_server3, ip_self}
        for ip in ip_addresses:
            if ip not in skip_ips:
                ip_target = ip
        return f"网段扫描成功：靶机IP地址为{ip_target}"


if __name__ == '__main__':
    attacking_machine = "kali"

    target_network = "192.168.92.0/24"
    # 创建 perform_network_scan 实例，并提供 name 和 description 字段的值
    scanner = perform_network_scan()
    # 调用 _run 方法并传递 network_segment 参数
    result = scanner._run()
    # result = scanner._run(network_segment=target_network)
    print(result)
    # connect = LinuxConnect(LHOST, username, password)
    # stdin, stdout, stderr =connect.ssh.exec_command('sudo -i')
    # print(stdout)