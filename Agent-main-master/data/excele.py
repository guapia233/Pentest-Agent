import pandas as pd
import json
import numpy as np

# 读取 Excel 文件
file_path = '样板.xls'
df = pd.read_excel(file_path)

# 打印原始数据以检查列名
print("原始数据：")
print(df)

# 提取总问题
total_question = df.iloc[0, 0]

# 删除第一行（总问题行）
df = df.drop(0).reset_index(drop=True)

# 重命名列
df.columns = ["description", "step_seq", "step_no", "attack_technique", "step_desc", "input", "tools"]

# 选取需要的列，并添加一个新的"sub_question_desc"列
df["sub_question_desc"] = df["description"]
df = df[["step_no", "attack_technique", "step_desc", "input", "tools", "sub_question_desc"]]

# 将 NaN 值替换为 None
df = df.replace({np.nan: None})

# 将数据转换为字典列表
sub_questions = df.to_dict(orient='records')

# 构建嵌套的 JSON 结构
output_data = {
    "description": total_question,
    "sub_questions": [{"sub_question_desc": sub["sub_question_desc"], **{k: v for k, v in sub.items() if k != "sub_question_desc"}} for sub in sub_questions]
}

# 将数据转换为 JSON 格式
json_output = json.dumps(output_data, ensure_ascii=False, indent=4)

# 输出 JSON
print(json_output)

# 保存到文件
with open('output.json', 'w', encoding='utf-8') as f:
    f.write(json_output)